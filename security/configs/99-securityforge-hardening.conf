# SecurityForge Linux - Hardening Extremo do Kernel
# Este arquivo deve ser colocado em /etc/sysctl.d/99-securityforge-hardening.conf

# ============================================================================
# PROTEÇÃO DE MEMÓRIA E EXECUÇÃO
# ============================================================================

# Proteção de execução em pilha
kernel.exec-shield = 1

# Randomização do espaço de endereço (máximo)
kernel.randomize_va_space = 2

# Proteção de ponteiros do kernel
kernel.kptr_restrict = 2

# Restrição de acesso ao dmesg
kernel.dmesg_restrict = 1

# Cores dumps seguros
kernel.core_uses_pid = 1
kernel.core_pattern = |/bin/false
fs.suid_dumpable = 0

# Proteção YAMA avançada
kernel.yama.ptrace_scope = 3
kernel.yama.protected_sticky_symlinks = 1
kernel.yama.protected_nonaccess_hardlinks = 1

# ============================================================================
# PROTEÇÃO DE SISTEMA DE ARQUIVOS
# ============================================================================

# Proteção de links simbólicos e hardlinks
fs.protected_symlinks = 1
fs.protected_hardlinks = 1
fs.protected_fifos = 2
fs.protected_regular = 2

# Proteção adicional de arquivos
fs.mount_max = 100000

# ============================================================================
# CONFIGURAÇÕES DE REDE EXTREMAMENTE SEGURAS
# ============================================================================

# Desabilitar forwarding IP
net.ipv4.ip_forward = 0
net.ipv4.conf.all.forwarding = 0
net.ipv4.conf.default.forwarding = 0
net.ipv6.conf.all.forwarding = 0
net.ipv6.conf.default.forwarding = 0

# Proteção contra redirects ICMP
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Proteção contra source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Proteção contra router advertisements IPv6
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0
net.ipv6.conf.all.accept_ra_defrtr = 0
net.ipv6.conf.default.accept_ra_defrtr = 0
net.ipv6.conf.all.accept_ra_pinfo = 0
net.ipv6.conf.default.accept_ra_pinfo = 0

# Logging de pacotes suspeitos (martians)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Proteção ICMP
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.icmp_echo_ignore_all = 0

# Proteção SYN flood
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 4096

# Proteção contra time-wait assassination
net.ipv4.tcp_rfc1337 = 1

# Configurações TCP otimizadas para segurança
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 1800
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_keepalive_probes = 5

# Proteção contra ataques de timing
net.ipv4.tcp_challenge_ack_limit = 100

# BPF hardening
net.core.bpf_jit_harden = 2

# Configurações de buffer de rede
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 5000

# ============================================================================
# CONFIGURAÇÕES DE MEMÓRIA VIRTUAL
# ============================================================================

# Proteção de memória virtual
vm.mmap_min_addr = 65536
vm.mmap_rnd_bits = 32
vm.mmap_rnd_compat_bits = 16

# Configurações de swap otimizadas
vm.swappiness = 10
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5
vm.vfs_cache_pressure = 50

# Proteção contra overflow de heap
vm.heap_stack_gap = 65536

# ============================================================================
# CONFIGURAÇÕES DE SEGURANÇA DIVERSAS
# ============================================================================

# Magic SysRq completamente desabilitado
kernel.sysrq = 0

# Melhorar entropia do sistema
kernel.random.write_wakeup_threshold = 128
kernel.random.read_wakeup_threshold = 64

# Configurações de scheduler para segurança
kernel.sched_autogroup_enabled = 0
kernel.sched_child_runs_first = 0

# Proteção adicional de processo
kernel.pid_max = 4194304

# Limitar número de processos por usuário
kernel.threads-max = 2097152

# ============================================================================
# DESABILITAR IPv6 (OPCIONAL - DESCOMENTE SE NECESSÁRIO)
# ============================================================================

# Desabilitar IPv6 completamente se não for necessário
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1
# net.ipv6.conf.lo.disable_ipv6 = 1

# ============================================================================
# CONFIGURAÇÕES DE DEBUG E DESENVOLVIMENTO
# ============================================================================

# Desabilitar debugging de kernel
kernel.kexec_load_disabled = 1
kernel.perf_event_paranoid = 3
kernel.kptr_restrict = 2

# ============================================================================
# HARDENING ADICIONAL PARA CONTAINERS
# ============================================================================

# Configurações para ambientes containerizados
user.max_user_namespaces = 0
kernel.unprivileged_userns_clone = 0

# ============================================================================
# APLICAR CONFIGURAÇÕES IMEDIATAMENTE
# ============================================================================
# Para aplicar: sysctl -p /etc/sysctl.d/99-securityforge-hardening.conf
